<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Raport Użytkowników</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .table-container {
            max-height: 600px;
            overflow-y: auto;
        }
        .filter-section {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .btn-export {
            margin-right: 10px;
        }
        .toast {
            min-width: 300px;
        }
        .toast-container {
            z-index: 1055;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <h1 class="mb-4">
            <i class="fas fa-users"></i> 
            Dashboard - Raport Użytkowników
        </h1>

        <!-- Filtry -->
        <div class="filter-section">
            <h5><i class="fas fa-filter"></i> Filtry</h5>
            <div class="row">
                <div class="col-md-2">
                    <label for="nameFilter" class="form-label">Imię i Nazwisko</label>
                    <input type="text" class="form-control" id="nameFilter" placeholder="Wpisz imię...">
                </div>
                <div class="col-md-2">
                    <label for="phoneFilter" class="form-label">Telefon</label>
                    <input type="text" class="form-control" id="phoneFilter" placeholder="Wpisz telefon...">
                </div>
                <div class="col-md-2">
                    <label for="addressFilter" class="form-label">Adres</label>
                    <input type="text" class="form-control" id="addressFilter" placeholder="Wpisz adres...">
                </div>
                <div class="col-md-2">
                    <label for="ageFilter" class="form-label">Wiek</label>
                    <input type="number" class="form-control" id="ageFilter" placeholder="Wiek">
                </div>
                <div class="col-md-2">
                    <label for="educationFilter" class="form-label">Wykształcenie</label>
                    <select class="form-select" id="educationFilter">
                        <option value="">Wszystkie</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">&nbsp;</label>
                    <button class="btn btn-primary w-100" onclick="applyFilters()">
                        <i class="fas fa-search"></i> Filtruj
                    </button>
                </div>
            </div>
        </div>

        <!-- Sortowanie i Eksport -->
        <div class="row mb-3">
            <div class="col-md-6">
                <div class="d-flex align-items-center">
                    <label for="sortBy" class="form-label me-2">Sortuj po:</label>
                    <select class="form-select me-2" id="sortBy" style="width: auto;">
                        <option value="id">ID</option>
                        <option value="name">Imię i Nazwisko</option>
                        <option value="phoneNumber">Telefon</option>
                        <option value="address">Adres</option>
                        <option value="age">Wiek</option>
                    </select>
                    <select class="form-select me-3" id="sortOrder" style="width: auto;">
                        <option value="ASC">Rosnąco</option>
                        <option value="DESC">Malejąco</option>
                    </select>
                    <button class="btn btn-secondary" onclick="applySorting()">
                        <i class="fas fa-sort"></i> Sortuj
                    </button>
                </div>
            </div>
            <div class="col-md-6 text-end">
                <button class="btn btn-success btn-export" onclick="exportData('xls')">
                    <i class="fas fa-file-excel"></i> Eksport XLS
                </button>
                <button class="btn btn-danger btn-export" onclick="exportData('pdf')">
                    <i class="fas fa-file-pdf"></i> Eksport PDF
                </button>
                <button class="btn btn-primary" onclick="showAddUserModal()">
                    <i class="fas fa-plus"></i> Dodaj Użytkownika
                </button>
            </div>
        </div>

        <!-- Tabela użytkowników -->
        <div class="table-container">
            <table class="table table-striped table-hover">
                <thead class="table-dark sticky-top">
                    <tr>
                        <th>ID</th>
                        <th>Imię i Nazwisko</th>
                        <th>Telefon</th>
                        <th>Adres</th>
                        <th>Wiek</th>
                        <th>Wykształcenie</th>
                        <th>Akcje</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                    <!-- Dane będą ładowane dynamicznie -->
                </tbody>
            </table>
        </div>

        <!-- Paginacja -->
        <nav aria-label="Paginacja">
            <ul class="pagination justify-content-center" id="pagination">
                <!-- Paginacja będzie generowana dynamicznie -->
            </ul>
        </nav>
    </div>

    <!-- Toast Container dla komunikatów -->
    <div class="toast-container position-fixed top-0 end-0 p-3" id="toastContainer" style="z-index: 1055;">
        <!-- Toasty będą dodawane dynamicznie -->
    </div>

    <!-- Modal dodawania/edycji użytkownika -->
    <div class="modal fade" id="userModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Dodaj Użytkownika</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="userForm">
                        <input type="hidden" id="userId">
                        <div class="mb-3">
                            <label for="userName" class="form-label">Imię i Nazwisko *</label>
                            <input type="text" class="form-control" id="userName" required>
                        </div>
                        <div class="mb-3">
                            <label for="userPhone" class="form-label">Telefon *</label>
                            <input type="text" class="form-control" id="userPhone" required>
                        </div>
                        <div class="mb-3">
                            <label for="userAddress" class="form-label">Adres *</label>
                            <textarea class="form-control" id="userAddress" rows="3" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="userAge" class="form-label">Wiek *</label>
                            <input type="number" class="form-control" id="userAge" min="1" max="150" required>
                        </div>
                        <div class="mb-3">
                            <label for="userEducation" class="form-label">Wykształcenie</label>
                            <select class="form-select" id="userEducation">
                                <option value="">Wybierz wykształcenie</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
                    <button type="button" class="btn btn-primary" onclick="saveUser()">Zapisz</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentPage = 1;
        let currentFilters = {};
        let currentSorting = {};

        // Inicjalizacja
        document.addEventListener('DOMContentLoaded', function() {
            loadEducations();
            loadUsers();
        });

        // Ładowanie wykształceń
        async function loadEducations() {
            try {
                const response = await fetch('/api/education');
                const educations = await response.json();
                
                const filterSelect = document.getElementById('educationFilter');
                const modalSelect = document.getElementById('userEducation');
                
                educations.forEach(education => {
                    const option = new Option(education.name, education.id);
                    filterSelect.add(option.cloneNode(true));
                    modalSelect.add(option);
                });
            } catch (error) {
                console.error('Błąd podczas ładowania wykształceń:', error);
            }
        }

        // Ładowanie użytkowników
        async function loadUsers() {
            try {
                const params = new URLSearchParams({
                    page: currentPage,
                    limit: 10,
                    ...currentFilters,
                    ...currentSorting
                });

                const response = await fetch(`/api/users?${params}`);
                const data = await response.json();
                
                displayUsers(data.data);
                displayPagination(data.pagination);
            } catch (error) {
                console.error('Błąd podczas ładowania użytkowników:', error);
            }
        }

        // Wyświetlanie użytkowników
        function displayUsers(users) {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';

            users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.id}</td>
                    <td>${user.name}</td>
                    <td>${user.phone_number}</td>
                    <td>${user.address}</td>
                    <td>${user.age}</td>
                    <td>${user.education ? user.education.name : '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-warning me-1" onclick="editUser(${user.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteUser(${user.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Wyświetlanie paginacji
        function displayPagination(pagination) {
            const paginationElement = document.getElementById('pagination');
            paginationElement.innerHTML = '';

            // Poprzednia strona
            if (pagination.page > 1) {
                const prevLi = document.createElement('li');
                prevLi.className = 'page-item';
                prevLi.innerHTML = `<a class="page-link" href="#" onclick="goToPage(${pagination.page - 1})">Poprzednia</a>`;
                paginationElement.appendChild(prevLi);
            }

            // Numery stron
            for (let i = 1; i <= pagination.pages; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === pagination.page ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#" onclick="goToPage(${i})">${i}</a>`;
                paginationElement.appendChild(li);
            }

            // Następna strona
            if (pagination.page < pagination.pages) {
                const nextLi = document.createElement('li');
                nextLi.className = 'page-item';
                nextLi.innerHTML = `<a class="page-link" href="#" onclick="goToPage(${pagination.page + 1})">Następna</a>`;
                paginationElement.appendChild(nextLi);
            }
        }

        // Przejście do strony
        function goToPage(page) {
            currentPage = page;
            loadUsers();
        }

        // Zastosowanie filtrów
        function applyFilters() {
            currentFilters = {};
            
            const name = document.getElementById('nameFilter').value;
            const phone = document.getElementById('phoneFilter').value;
            const address = document.getElementById('addressFilter').value;
            const age = document.getElementById('ageFilter').value;
            const education = document.getElementById('educationFilter').value;

            if (name) currentFilters.name = name;
            if (phone) currentFilters.phone_number = phone;
            if (address) currentFilters.address = address;
            if (age) currentFilters.age = age;
            if (education) currentFilters.education_id = education;

            currentPage = 1;
            loadUsers();
        }

        // Zastosowanie sortowania
        function applySorting() {
            currentSorting = {
                sort_by: document.getElementById('sortBy').value,
                sort_order: document.getElementById('sortOrder').value
            };
            loadUsers();
        }

        // Eksport danych
        function exportData(format) {
            const params = new URLSearchParams({
                format: format,
                ...currentFilters,
                ...currentSorting
            });

            window.open(`/api/export?${params}`, '_blank');
        }

        // Pokazanie modala dodawania użytkownika
        function showAddUserModal() {
            document.getElementById('modalTitle').textContent = 'Dodaj Użytkownika';
            document.getElementById('userForm').reset();
            document.getElementById('userId').value = '';
            
            const modal = new bootstrap.Modal(document.getElementById('userModal'));
            modal.show();
        }

        // Edycja użytkownika
        async function editUser(id) {
            try {
                const response = await fetch(`/api/users?id=${id}`);
                const user = await response.json();
                
                document.getElementById('modalTitle').textContent = 'Edytuj Użytkownika';
                document.getElementById('userId').value = user.id;
                document.getElementById('userName').value = user.name;
                document.getElementById('userPhone').value = user.phone_number;
                document.getElementById('userAddress').value = user.address;
                document.getElementById('userAge').value = user.age;
                document.getElementById('userEducation').value = user.education ? user.education.id : '';
                
                const modal = new bootstrap.Modal(document.getElementById('userModal'));
                modal.show();
            } catch (error) {
                console.error('Błąd podczas ładowania użytkownika:', error);
                showErrorMessage('Błąd podczas ładowania danych użytkownika');
            }
        }

        // Zapisywanie użytkownika
        async function saveUser() {
            const userId = document.getElementById('userId').value;
            const userData = {
                name: document.getElementById('userName').value,
                phone_number: document.getElementById('userPhone').value,
                address: document.getElementById('userAddress').value,
                age: parseInt(document.getElementById('userAge').value),
                education_id: document.getElementById('userEducation').value || null
            };

            try {
                const url = userId ? '/api/users' : '/api/users';
                const method = userId ? 'PUT' : 'POST';
                
                if (userId) {
                    userData.id = userId;
                }

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(userData)
                });

                if (response.ok) {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('userModal'));
                    modal.hide();
                    showSuccessMessage(userId ? 'Użytkownik został pomyślnie zaktualizowany!' : 'Użytkownik został pomyślnie dodany!');
                    loadUsers();
                } else {
                    const error = await response.json();
                    showErrorMessage('Błąd: ' + (error.error || 'Nieznany błąd'));
                }
            } catch (error) {
                console.error('Błąd podczas zapisywania użytkownika:', error);
                showErrorMessage('Błąd podczas zapisywania użytkownika');
            }
        }

        // Usuwanie użytkownika
        async function deleteUser(id) {
            if (!confirm('Czy na pewno chcesz usunąć tego użytkownika?')) {
                return;
            }

            try {
                const response = await fetch(`/api/users?id=${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    // Pokaż popup z informacją o sukcesie
                    showSuccessMessage('Użytkownik został pomyślnie usunięty!');
                    loadUsers();
                } else {
                    const error = await response.json();
                    showErrorMessage('Błąd: ' + (error.error || 'Nieznany błąd'));
                }
            } catch (error) {
                console.error('Błąd podczas usuwania użytkownika:', error);
                showErrorMessage('Błąd podczas usuwania użytkownika');
            }
        }

        // Funkcja do wyświetlania komunikatów sukcesu
        function showSuccessMessage(message) {
            const toastContainer = document.getElementById('toastContainer');
            const toastHtml = `
                <div class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            <i class="fas fa-check-circle me-2"></i>${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;
            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            
            const toastElement = toastContainer.lastElementChild;
            const toast = new bootstrap.Toast(toastElement);
            toast.show();
            
            // Usuń toast po zakończeniu animacji
            toastElement.addEventListener('hidden.bs.toast', function() {
                toastElement.remove();
            });
        }

        // Funkcja do wyświetlania komunikatów błędów
        function showErrorMessage(message) {
            const toastContainer = document.getElementById('toastContainer');
            const toastHtml = `
                <div class="toast align-items-center text-white bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            <i class="fas fa-exclamation-circle me-2"></i>${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;
            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            
            const toastElement = toastContainer.lastElementChild;
            const toast = new bootstrap.Toast(toastElement);
            toast.show();
            
            // Usuń toast po zakończeniu animacji
            toastElement.addEventListener('hidden.bs.toast', function() {
                toastElement.remove();
            });
        }
    </script>
</body>
</html> 